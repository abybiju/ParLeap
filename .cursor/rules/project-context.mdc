---
description: ParLeap project context and memory - current status and architecture
alwaysApply: true
---

# ParLeap Project Context

## Current Status (February 2026)

ParLeap is a **real-time AI-powered presentation orchestration platform** for live events. It automates slide switching by listening to speakers/singers and matching audio to pre-loaded content.

### Production Deployments
- **Frontend**: https://www.parleap.com (Vercel)
- **Backend**: https://parleapbackend-production.up.railway.app (Railway)
- **Database**: Supabase (PostgreSQL)

### Completed Phases
- ✅ Phase 1: Foundation (Monorepo, Next.js 14, Express/TypeScript)
- ✅ Phase 2: Real-Time Engine (WebSocket, Audio Capture, ElevenLabs STT)
- ✅ Phase 3: Predictive Matching (Fuzzy matching, auto-advance)
- ✅ Phase 4: Frontend Features (Songs Library, Operator Console, Event Management)
- ✅ Phase 5: Testing & QA (147 tests, CI/CD pipeline)
- ✅ **Adaptive Live Mode** (Multi-song matching, manual override, auto-follow toggle)

### Testing Infrastructure
- **Backend**: Jest (67 unit + 16 integration tests)
- **Frontend**: Vitest (48 unit tests)
- **E2E**: Playwright (configured)
- **CI/CD**: GitHub Actions (lint, type-check, build)

### Key Architecture Decisions
1. **STT Provider**: ElevenLabs Scribe (realtime streaming)
2. **Matching Algorithm**: `string-similarity` with multi-song support
   - Current song checked first (Priority 1)
   - Other songs only if confidence < 60%
   - 85%+ threshold for auto-switch, 60-85% for suggestions
   - Debouncing: 2 sustained matches + 3s cooldown
3. **WebSocket**: Native `ws` library (NOT Socket.io)
4. **State**: Zustand for frontend, in-memory session state for backend
5. **Audio Format**: PCM for ElevenLabs, WebM Opus for Google
6. **Matching Philosophy**: Single source of truth (backend only, no client-side matching)
7. **Hum-to-Search**: Dual-path — YouTube-style (768D Wav2Vec2 via Python microservice) preferred; BasicPitch (128D) fallback. Live streaming hum match available.
8. **Supabase client**: Lazy-initialized (`getSupabaseClient()`) — reads env on first access, not module load. Critical for scripts using dotenv.

### Recent Features

**Songs UX: metadata, CCLI templates, community save** (February 2026)
- **Strict metadata + iTunes Auto-Fill**: Format-song prompt (formatSongService) has METADATA RULES — artist only from explicit cues (By, Written by, Artist:, ©); no guessing. `metadataSearch.ts`: `findSongMetadata(query)` via iTunes Search API (no key). Song editor: Wand2 "Auto-Fill" next to Title fills Artist; toast on success / no match.
- **CCLI-only template fetch**: On CCLI entry, fetch community templates by CCLI only (no lyrics). "Community formats for this CCLI" shows line count, upvotes, "Use this format". SongPreviewCards: `templatesFromCcliOnly` + `selectedTemplateId`; applies template when pasted lyrics line count matches; section labels (Verse, Chorus, Bridge) not counted in content line count.
- **Community template after Create Song**: Dialog "Save this format to Template Community?" [No / Yes]. Backend max 3 formats per CCLI; when limit reached returns `limitReached`, song still created; toasts for saved / limit / just create.
- **Similar-line matcher**: matcherService blocks next-line advance when current vs target line similarity ≥ SIMILAR_LINE_THRESHOLD (0.65); advance only via end-of-line. Prevents jumping on repeated/similar lines.
- **STT/latency**: Instrumentation and docs (STT_LATENCY_MEASUREMENT.md); quick wins (projector setTimeout removed, 1024 buffer). Stick with ElevenLabs for now.

**Landing: Ready for any song + album art** (February 18, 2026)
- **FlowScrollLine**: Replaced LyricWall with scroll-driven "Ready for any song" section; 12 titles (Firm Foundation, What A Beautiful Name, King Of Kings, etc.); tightened spacing (no big gap).
- **WorshipStream**: Dual source — iTunes worship search + Apple Music top albums RSS; merge worship-first, max 40; refresh every 6h and on focus; `Promise.allSettled` so one failing source (e.g. CORS) doesn’t hide the other.

**Live session fixes** (February 17, 2026)
- **Matcher crash when jumping songs**: Clamp `currentLineIndex` to valid range in handler (GO_TO_ITEM, SESSION_STARTED) and in matcher (`effectiveLineIndex`); guard `getAdaptiveEndTrigger` for undefined/empty text. Prevents "slide stuck" and `Cannot read properties of undefined (reading 'trim')`.
- **Event Not Found**: Clearer backend log and error message (Supabase URL/service role key). Frontend toast suggests checking backend env on production. NextSlidePreview: "Start session to see next slide" when no setlist instead of "End of setlist".
- **RATE_LIMITED**: START_SESSION exempt from WebSocket control rate limit so "Start session" never triggers it. Friendlier frontend toast when RATE_LIMITED occurs.

**Hum-to-Search: YouTube-style embedding + live hum** (February 16, 2026)
- Python embedding microservice (`hum-embedding-service/`): FastAPI + Wav2Vec2, POST WAV → 768D vector. Deployed to Railway.
- Audio trimmed to 30s max to prevent OOM on full-length tracks (was causing EPIPE errors).
- Supabase migration 017: `embedding vector(768)` column, IVFFlat index, `match_songs_by_embedding()` RPC.
- Dual-path: YouTube-style (768D, when `EMBEDDING_SERVICE_URL` set) or BasicPitch (128D, default).
- Live hum-to-search: stream 2s chunks, 5s rolling buffer, match on the fly. Endpoints: `live/available`, `live/start`, `live/chunk`, `live/stop`.
- Ingest script: dual-vector (128D + 768D), retry 3x with backoff. 2 songs ingested.
- **Lazy Supabase init**: `supabase.ts` refactored to read env on first access (not module load). Fixes false "not configured" warning in scripts. All 8 consumer files updated to `getSupabaseClient()` / `isSupabaseConfigured()`.
- Status: Deployed, end-to-end testing pending.

**Event edit workspace + structured announcement text**
- Event edit page: Spotify-style — left sidebar (event form + Setlist/Content Library nav), full-width main switching between Setlist and Content Library. View-switch animation (Framer Motion); overflow-x-hidden on main. Components: EventEditWorkspace, EventEditSidebar, EventFormCompact, SetlistView.
- Structured announcement text: Optional exact wording per slide (title, subtitle, date, lines). "Exact wording" section in Announcement tab; projector shows this text (with optional image as background). Revert with `git revert cc62e39` if removing.

**Announcement click shows image on operator and projector** (February 15, 2026)
- Operator: CurrentSlideDisplay renders slideImageUrl/slideVideoUrl so announcement pictures show when clicked in setlist.
- Backend: GO_TO_ITEM accepts optional itemId when itemIndex out of range; fetchEventItemById loads event_item with announcement_slides; handler broadcasts DISPLAY_UPDATE with slideImageUrl. Frontend sends goToItem(index, item.id).

**Grab Text + announcement device upload + canvas eraser** (February 15, 2026)
- Grab Text: Tesseract.js client-side OCR in Announcement tab; pre-fills Exact wording from image (URL or file). Best for straight, Latin text.
- Device upload: Add files as slides → upload to `announcement-assets` on Add to setlist. Migration 014 (RLS); bucket `announcement-assets` create in Dashboard if needed.
- Clean image: react-konva editor with eraser brush (frontend-only); Save exports PNG, uploads, updates slide URL. See `CANVA_GRAB_TEXT_RESEARCH.md`.

**Password reset / Forgot password**
- `/auth/forgot-password`: request reset link; `/auth/reset-password`: set new password from email link
- Login page has "Forgot your password?"; Profile Security has "Reset Password" modal
- Supabase Site URL and Redirect URLs must use production domain (e.g. www.parleap.com) for recovery emails

**Bible semantic (vector) and refinements** (February 13, 2026)
- Semantic (OpenAI embeddings) for Bible only: verse-by-content open, Bible Follow, in-chapter jump by content. Lyrics remain fuzzy.
- Full-Bible open: keyword search on `bible_verses.search_text` then semantic rerank; fallback to 15 verses. Chapter-only refs ("Luke 1" → 1:1), book soundalikes ("roman" → Romans), fuzzy book match (≥ 0.82).
- **STT homophones**: "daniel won" → Daniel 1 via `normalizeReferenceText` (won/one→1, two/too→2, for/four→4, ate/eight→8; "to" not changed for range "1 to 3").
- **Known issues (todo)**: Bible verse **advance** not working reliably; **cross-chapter/cross-book jump** not reliable. See `BIBLE_SEMANTIC_BACKLOG.md` for full backlog.

**Smart Bible Listen** (February 11, 2026) — IN PROGRESS
- Smart Listen toggle in operator HUD gates STT for Bible items
- Frontend: audio buffered until wake word or "Listen now" triggers STT window
- Backend: `shouldUseSmartListenGate()` checks `session.smartListenEnabled && currentItemIsBible`
- Kill switch: `BIBLE_SMART_LISTEN_ENABLED=false` to force-disable server-side
- **Known issue**: Bible items still not appearing in live setlist after session starts (fix deployed, needs verification)
- Debug endpoint available: `/api/debug/event-items/:eventId`

**Polymorphic setlist** — Bible items in live setlist
- Backend eventService uses split queries (no songs() embed) to avoid PostgREST INNER JOIN issue
- Frontend SetlistPanel merges missing Bible/Media from initialSetlist
- OperatorHUD tracks currentItemIsBible from local clicks + backend messages

**Landing page** – Scripture section ("And scripture too." with three cards, Bible Verses in marquee) and Live Console showcase (operator screenshot with 3D tilt, hover glow, click-to-open lightbox).

**Adaptive Live Mode** (January 27, 2026)
- Multi-song matching: AI detects when singer jumps to different song
- Debouncing: Requires 2 sustained matches before auto-switch
- Auto-follow toggle: Operator can disable AI and take manual control
- Clickable setlist: Click any song to jump immediately
- Song suggestions: Toast notifications for medium-confidence matches (60-85%)
- Smart optimization: Current song checked first, others only if confidence drops

### Session Summaries Location
Recent work is documented in `.cursor/SESSION_SUMMARY_*.md` files and `memory/` daily logs.
- **Live session fixes (Feb 17)**: `memory/2026-02-17.md`
- **Hum-to-search (Feb 16)**: `memory/2026-02-16.md`
- **Password reset**: `SESSION_SUMMARY_PASSWORD_RESET.md`
- **Bible/Smart Listen**: `SESSION_SUMMARY_FEB_11_2026.md`

### To-Do List (see PROJECT_PLAN.md § To-Do List)
- Brainstorm semantic AI / Hugging Face (open-source embeddings in Node/Edge)
- Work on humming search feature (Hum-to-Search; see `HUM_SEARCH_STATUS.md`)
- Background visuals for projector view (optional image/video/motion layer; see `BACKGROUND_AND_ANNOUNCEMENTS_ROADMAP.md`)
- Announcement slides + Ideogram AI (announcement slide type; prompt → Ideogram API → add to slides; see Ideogram API docs)
- Expand projector font options (e.g. Google Fonts API or other APIs)

### Important Files
- `PROJECT_PLAN.md` - Master roadmap and to-do list
- `HUM_SEARCH_STATUS.md` - Hum-to-Search status (dual-path, live hum, deployment, testing)
- `hum-embedding-service/` - Python FastAPI embedding microservice (Wav2Vec2, 768D)
- `CANVA_GRAB_TEXT_RESEARCH.md` - Grab Text research (Canva behavior, build-your-own OCR + eraser)
- `BACKGROUND_AND_ANNOUNCEMENTS_ROADMAP.md` - Background visuals and announcement slides (ProPresenter/ProContent context, ParLeap roadmap)
- `BIBLE_SEMANTIC_BACKLOG.md` - Bible semantic shipped behavior and backlog (cross-chapter jump, latency, open-source semantic brainstorm)
- `TESTING_INFRASTRUCTURE_COMPLETE.md` - Test coverage details
- `.cursorrules` - Full architecture specification
- `CLAWDBOT_INSTRUCTIONS.md` - Operational directives for autonomous AI work (Governor System)

### ClawdBot Governor System
- **Status**: Active (January 26, 2026)
- **File**: `CLAWDBOT_INSTRUCTIONS.md`
- **Purpose**: Safety protocols and operational directives for autonomous AI work
- **Integration**: References SOUL.md, AGENTS.md, .cursorrules, and project documentation
