# Daily Memory - January 29, 2026

## Hum-to-Search UI Components Implementation

### What We Accomplished Today

#### 1. Hum-to-Search UI Components ✅
- **HumButton Component**: Created `frontend/components/search/HumButton.tsx`
  - Circular microphone button with Lucide `Mic` icon
  - Two states: Idle (gray) and Listening (red with pulsing ring)
  - Uses Tailwind `animate-ping` for pulsing ring effect
  - Click toggles listening state
  - Manages `ListeningOverlay` visibility

- **ListeningOverlay Component**: Created `frontend/components/search/ListeningOverlay.tsx`
  - Full-screen overlay with dark backdrop (`bg-black/80`)
  - Centered glassmorphism card with "Hum a song..." text
  - CSS-only waveform animation (12 vertical bars)
  - Uses existing `animate-waveform` keyframe from `tailwind.config.ts`
  - Staggered animation delays (0.08s intervals) for wave effect
  - Orange-to-red gradient bars matching brand colors
  - Click backdrop to close

- **Integration**: Updated `SongDataTable.tsx`
  - Added `HumButton` next to search input
  - Wrapped in flex container for proper layout
  - No changes to existing search functionality

- **Component Structure**: Created `frontend/components/search/` directory
  - `HumButton.tsx` - Main button component
  - `ListeningOverlay.tsx` - Overlay modal component  
  - `index.ts` - Export barrel file

#### 2. Git Commit ✅
- **Commit**: `828e885` - "Add Hum-to-Search UI components (visuals only)"
- **Files Changed**: 4 files (3 new, 1 modified)
- **Status**: Committed locally, push pending due to network issues

#### 3. Design Implementation Details
- **Visual-Only**: No audio recording logic implemented yet (as specified)
- **Design Tokens**: Reuses existing `glass-card`, `animate-ping`, `animate-waveform`
- **Accessibility**: Includes aria-labels and focus states
- **Consistency**: Follows existing component patterns and styling

### Technical Notes
- Components use `'use client'` directive (Next.js App Router)
- Uses `cn()` utility from `@/lib/utils` for class merging
- Waveform animation is pure CSS (no JavaScript-driven animation)
- Overlay uses `fixed inset-0` positioning with `z-50` for proper layering

### Testing Location
- **URL**: `/songs` page (Song Library)
- **Location**: Next to the "Search songs..." input field
- **Requires**: User authentication (redirects to login if not authenticated)

---

## Hum-to-Search Ingestion Pipeline Implementation

### What We Accomplished Today

#### 1. Complete Ingestion Pipeline Built ✅
- **Database Migration**: Created `supabase/migrations/003_add_melody_vectors.sql`
  - Enables pgvector extension
  - Creates `song_fingerprints` table with 128D vector column
  - Creates `ivfflat` index for fast cosine similarity search
  - Creates `match_songs()` function for querying

- **Melody Service**: Created `backend/src/services/melodyService.ts`
  - Key + tempo invariant melody extraction algorithm
  - Converts audio → MIDI notes → interval deltas (64D) + rhythm ratios (64D) = 128D vector
  - Handles mono/stereo conversion
  - Filters polyphonic to monophonic melody

- **Ingestion Script**: Created `backend/scripts/ingest-audio.ts`
  - Processes WAV files from `backend/songs_input/`
  - Extracts title/artist from filenames
  - Processes through melody extraction
  - Inserts/updates fingerprints in Supabase
  - Comprehensive error handling and logging

#### 2. Dependencies Installed ✅
- `@spotify/basic-pitch@1.0.1` - AI pitch detection
- `wavefile@11.0.0` - WAV file decoding
- `glob@10.3.10` - File pattern matching
- `@tensorflow/tfjs@4.22.0` - Pure JS TensorFlow (no native compilation)

#### 3. Package.json Updated ✅
- Added `"ingest": "tsx scripts/ingest-audio.ts"` script
- All dependencies properly configured

#### 4. Files Moved ✅
- WAV files moved from `frontend/components/songs/songs_input/` to `backend/songs_input/`
  - `Amazing_Grace_How_Sweet_The_Sound_-_CeeNaija_Gospel_Hymns_CeeNaija.com_.wav` (43MB)
  - `Leeland-Way-Maker-CEENAIJA.COM_.wav` (92MB)

### Technical Challenges Resolved

1. **Package Version Issues**:
   - Fixed `@spotify/basic-pitch` version from `^1.1.0` to `^1.0.1` (actual published version)
   - Removed `@types/glob` (glob v10 has built-in types)

2. **TensorFlow.js Issues**:
   - Initially tried `@tensorflow/tfjs-node` but failed due to:
     - No pre-built binaries for Node.js 24.11.1
     - Native compilation failed due to space in folder path
   - Switched to `@tensorflow/tfjs` (pure JS) - works but slower
   - BasicPitch handles model loading internally

3. **BasicPitch API Integration**:
   - Updated to use correct callback-based API
   - Uses `outputToNotesPoly()`, `addPitchBendsToNoteEvents()`, `noteFramesToTime()`
   - Model path detection with fallbacks

4. **TypeScript Errors Fixed**:
   - Fixed wavefile sample type conversions
   - Removed unused imports
   - All type-checking passes

### Current Blocker: Folder Name with Space

**Issue**: Folder name "ParLeap AI" (with space) causes:
- `tsx` pipe creation failures (`EPERM` error)
- TensorFlow native build failures (path parsing issues)
- General path-related issues with build tools

**Solution**: User will rename folder to "ParLeap-AI" (dash instead of space)

### Next Steps After Folder Rename

1. **Reinstall Dependencies**:
   ```bash
   cd backend && rm -rf node_modules && npm install
   ```

2. **Apply Database Migration**:
   - User needs to run `003_add_melody_vectors.sql` in Supabase dashboard SQL editor
   - Enable pgvector extension if not already enabled

3. **Test Ingestion**:
   ```bash
   cd backend && npm run ingest
   ```
   - First run will be slow (model loading)
   - Should process 2 WAV files and store vectors in database

4. **Verify Results**:
   - Check `song_fingerprints` table in Supabase
   - Verify vectors are stored correctly

### Algorithm Details

**Key-Invariant + Tempo-Invariant Vector Extraction**:
- **Pitch Dimension (64 floats)**: Interval deltas (semitone differences between consecutive notes)
- **Rhythm Dimension (64 floats)**: Inter-onset intervals normalized to total duration
- **Total**: 128D vector stored in pgvector

**Why This Works**:
- Transposing key doesn't change pitch intervals
- Singing faster/slower doesn't change normalized rhythm ratios
- Enables "Hum-to-Search" regardless of key or tempo

### Files Created/Modified

**New Files**:
- `supabase/migrations/003_add_melody_vectors.sql`
- `backend/src/services/melodyService.ts`
- `backend/scripts/ingest-audio.ts`
- `backend/songs_input/` (directory with 2 WAV files)

**Modified Files**:
- `backend/package.json` (added dependencies and ingest script)

### Future Work

1. **Query Pipeline**: Build the "hum" query side (microphone → vector → search)
2. **YouTube Automation**: Future crawler to download audio, extract vectors, delete audio
3. **Performance**: Consider switching back to `@tensorflow/tfjs-node` after folder rename for speed

### Status (UPDATED)

- ✅ Folder renamed: "ParLeap AI" → "ParLeap-AI"
- ✅ Ingestion pipeline working!
- ✅ 2 songs processed (Way Maker + Amazing Grace)
- ✅ 128D vectors stored in Supabase
- ✅ Backend search API created (`POST /api/hum-search`)
- ✅ Frontend UI enhanced with real audio recording
- ✅ Beautiful animations added (pulse rings, waveform, fade-in)

---

## Part 2: Hum-to-Search Query Pipeline

### Backend Endpoint Created
- **Route**: `POST /api/hum-search`
- **Input**: `{ audio: base64, limit: 5, threshold: 0.4 }`
- **Output**: `{ success: true, results: [...], count: N }`
- **Service**: `humSearchService.ts` with `searchByHum()` function

### Technical Fixes Applied
1. **Monorepo model path**: Added `../node_modules/` lookups for hoisted packages
2. **Node.js 24 + tfjs-node**: Removed due to deprecated `isNullOrUndefined`
3. **file:// fetch**: Monkey-patched global fetch to read local files

### Frontend UI Enhanced
- Real audio recording with MediaRecorder
- Live waveform visualization with AudioContext
- 4 states: idle → recording → processing → results/error
- Auto-stop at 10 seconds
- Beautiful animations and error handling
