# Daily Memory - January 29, 2026

## Hum-to-Search UI Components Implementation

### What We Accomplished Today

#### 1. Hum-to-Search UI Components ✅
- **HumButton Component**: Created `frontend/components/search/HumButton.tsx`
  - Circular microphone button with Lucide `Mic` icon
  - Two states: Idle (gray) and Listening (red with pulsing ring)
  - Uses Tailwind `animate-ping` for pulsing ring effect
  - Click toggles listening state
  - Manages `ListeningOverlay` visibility

- **ListeningOverlay Component**: Created `frontend/components/search/ListeningOverlay.tsx`
  - Full-screen overlay with dark backdrop (`bg-black/80`)
  - Centered glassmorphism card with "Hum a song..." text
  - CSS-only waveform animation (12 vertical bars)
  - Uses existing `animate-waveform` keyframe from `tailwind.config.ts`
  - Staggered animation delays (0.08s intervals) for wave effect
  - Orange-to-red gradient bars matching brand colors
  - Click backdrop to close

- **Integration**: Updated `SongDataTable.tsx`
  - Added `HumButton` next to search input
  - Wrapped in flex container for proper layout
  - No changes to existing search functionality

- **Component Structure**: Created `frontend/components/search/` directory
  - `HumButton.tsx` - Main button component
  - `ListeningOverlay.tsx` - Overlay modal component  
  - `index.ts` - Export barrel file

#### 2. Git Commit ✅
- **Commit**: `828e885` - "Add Hum-to-Search UI components (visuals only)"
- **Files Changed**: 4 files (3 new, 1 modified)
- **Status**: Committed locally, push pending due to network issues

#### 3. Design Implementation Details
- **Visual-Only**: No audio recording logic implemented yet (as specified)
- **Design Tokens**: Reuses existing `glass-card`, `animate-ping`, `animate-waveform`
- **Accessibility**: Includes aria-labels and focus states
- **Consistency**: Follows existing component patterns and styling

### Technical Notes
- Components use `'use client'` directive (Next.js App Router)
- Uses `cn()` utility from `@/lib/utils` for class merging
- Waveform animation is pure CSS (no JavaScript-driven animation)
- Overlay uses `fixed inset-0` positioning with `z-50` for proper layering

### Testing Location
- **URL**: `/songs` page (Song Library)
- **Location**: Next to the "Search songs..." input field
- **Requires**: User authentication (redirects to login if not authenticated)

---

## Hum-to-Search Ingestion Pipeline Implementation

### What We Accomplished Today

#### 1. Complete Ingestion Pipeline Built ✅
- **Database Migration**: Created `supabase/migrations/003_add_melody_vectors.sql`
  - Enables pgvector extension
  - Creates `song_fingerprints` table with 128D vector column
  - Creates `ivfflat` index for fast cosine similarity search
  - Creates `match_songs()` function for querying

- **Melody Service**: Created `backend/src/services/melodyService.ts`
  - Key + tempo invariant melody extraction algorithm
  - Converts audio → MIDI notes → interval deltas (64D) + rhythm ratios (64D) = 128D vector
  - Handles mono/stereo conversion
  - Filters polyphonic to monophonic melody

- **Ingestion Script**: Created `backend/scripts/ingest-audio.ts`
  - Processes WAV files from `backend/songs_input/`
  - Extracts title/artist from filenames
  - Processes through melody extraction
  - Inserts/updates fingerprints in Supabase
  - Comprehensive error handling and logging

#### 2. Dependencies Installed ✅
- `@spotify/basic-pitch@1.0.1` - AI pitch detection
- `wavefile@11.0.0` - WAV file decoding
- `glob@10.3.10` - File pattern matching
- `@tensorflow/tfjs@4.22.0` - Pure JS TensorFlow (no native compilation)

#### 3. Package.json Updated ✅
- Added `"ingest": "tsx scripts/ingest-audio.ts"` script
- All dependencies properly configured

#### 4. Files Moved ✅
- WAV files moved from `frontend/components/songs/songs_input/` to `backend/songs_input/`
  - `Amazing_Grace_How_Sweet_The_Sound_-_CeeNaija_Gospel_Hymns_CeeNaija.com_.wav` (43MB)
  - `Leeland-Way-Maker-CEENAIJA.COM_.wav` (92MB)

### Technical Challenges Resolved

1. **Package Version Issues**:
   - Fixed `@spotify/basic-pitch` version from `^1.1.0` to `^1.0.1` (actual published version)
   - Removed `@types/glob` (glob v10 has built-in types)

2. **TensorFlow.js Issues**:
   - Initially tried `@tensorflow/tfjs-node` but failed due to:
     - No pre-built binaries for Node.js 24.11.1
     - Native compilation failed due to space in folder path
   - Switched to `@tensorflow/tfjs` (pure JS) - works but slower
   - BasicPitch handles model loading internally

3. **BasicPitch API Integration**:
   - Updated to use correct callback-based API
   - Uses `outputToNotesPoly()`, `addPitchBendsToNoteEvents()`, `noteFramesToTime()`
   - Model path detection with fallbacks

4. **TypeScript Errors Fixed**:
   - Fixed wavefile sample type conversions
   - Removed unused imports
   - All type-checking passes

### Current Blocker: Folder Name with Space

**Issue**: Folder name "ParLeap AI" (with space) causes:
- `tsx` pipe creation failures (`EPERM` error)
- TensorFlow native build failures (path parsing issues)
- General path-related issues with build tools

**Solution**: User will rename folder to "ParLeap-AI" (dash instead of space)

### Next Steps After Folder Rename

1. **Reinstall Dependencies**:
   ```bash
   cd backend && rm -rf node_modules && npm install
   ```

2. **Apply Database Migration**:
   - User needs to run `003_add_melody_vectors.sql` in Supabase dashboard SQL editor
   - Enable pgvector extension if not already enabled

3. **Test Ingestion**:
   ```bash
   cd backend && npm run ingest
   ```
   - First run will be slow (model loading)
   - Should process 2 WAV files and store vectors in database

4. **Verify Results**:
   - Check `song_fingerprints` table in Supabase
   - Verify vectors are stored correctly

### Algorithm Details

**Key-Invariant + Tempo-Invariant Vector Extraction**:
- **Pitch Dimension (64 floats)**: Interval deltas (semitone differences between consecutive notes)
- **Rhythm Dimension (64 floats)**: Inter-onset intervals normalized to total duration
- **Total**: 128D vector stored in pgvector

**Why This Works**:
- Transposing key doesn't change pitch intervals
- Singing faster/slower doesn't change normalized rhythm ratios
- Enables "Hum-to-Search" regardless of key or tempo

### Files Created/Modified

**New Files**:
- `supabase/migrations/003_add_melody_vectors.sql`
- `backend/src/services/melodyService.ts`
- `backend/scripts/ingest-audio.ts`
- `backend/songs_input/` (directory with 2 WAV files)

**Modified Files**:
- `backend/package.json` (added dependencies and ingest script)

### Future Work

1. **Query Pipeline**: Build the "hum" query side (microphone → vector → search)
2. **YouTube Automation**: Future crawler to download audio, extract vectors, delete audio
3. **Performance**: Consider switching back to `@tensorflow/tfjs-node` after folder rename for speed

### Status (UPDATED)

- ✅ Folder renamed: "ParLeap AI" → "ParLeap-AI"
- ✅ Ingestion pipeline working!
- ✅ 2 songs processed (Way Maker + Amazing Grace)
- ✅ 128D vectors stored in Supabase
- ✅ Backend search API created (`POST /api/hum-search`)
- ✅ Frontend UI enhanced with real audio recording
- ✅ Beautiful animations added (pulse rings, waveform, fade-in)

---

## Part 2: Hum-to-Search Query Pipeline

### Backend Endpoint Created
- **Route**: `POST /api/hum-search`
- **Input**: `{ audio: base64, limit: 5, threshold: 0.4 }`
- **Output**: `{ success: true, results: [...], count: N }`
- **Service**: `humSearchService.ts` with `searchByHum()` function

### Technical Fixes Applied
1. **Monorepo model path**: Added `../node_modules/` lookups for hoisted packages
2. **Node.js 24 + tfjs-node**: Removed due to deprecated `isNullOrUndefined`
3. **file:// fetch**: Monkey-patched global fetch to read local files

### Frontend UI Enhanced
- Real audio recording with MediaRecorder
- Live waveform visualization with AudioContext
- 4 states: idle → recording → processing → results/error
- Auto-stop at 10 seconds
- Beautiful animations and error handling

---

## Part 3: Production Debugging & Async Processing (End of Day)

### Issues Encountered

1. **Audio Format Mismatch** ❌ FIXED
   - Problem: Frontend recorded WebM, backend expected WAV
   - Solution: Created `audioUtils.ts` with WAV encoder, switched to AudioContext recording

2. **Payload Too Large (413 Error)** ❌ FIXED
   - Problem: 10 seconds of audio = 578KB base64, exceeded Express default limit
   - Solution: Reduced recording to 5 seconds, increased Express limit to 10MB

3. **Request Timeouts** ❌ FIXED (Async Solution)
   - Problem: BasicPitch inference takes 30-60 seconds, frontend timeout = 30s
   - Solution: Implemented async job queue pattern
     - Backend returns job ID immediately
     - Processes in background
     - Frontend polls for results every 1 second

4. **Timer Bug** ❌ FIXED
   - Problem: Timer went negative, auto-stop didn't work
   - Solution: Used refs instead of state closures, proper cleanup

5. **TypeScript Errors** ❌ FIXED
   - Problem: `any` types in jobQueue, missing type assertions
   - Solution: Used generics `Job<T>`, added type assertions

### Async Job Queue Implementation

**Backend (`backend/src/services/jobQueue.ts`):**
- In-memory job storage (Map<string, Job>)
- Job states: pending → processing → completed/failed
- Auto-cleanup of old jobs (1 hour TTL)

**Backend Endpoints:**
- `POST /api/hum-search` - Creates job, returns jobId immediately
- `GET /api/hum-search/:jobId` - Poll for job status/results

**Frontend Changes:**
- Creates job → gets jobId
- Polls `/api/hum-search/:jobId` every 1 second
- Shows "Analyzing melody..." spinner while polling
- Max 60 polling attempts (60 seconds)

### Files Created/Modified Today

**New Files:**
- `frontend/lib/audioUtils.ts` - WAV encoder utility
- `backend/src/services/jobQueue.ts` - Async job queue
- `backend/src/services/humSearchService.ts` - Search service

**Modified Files:**
- `frontend/components/search/ListeningOverlay.tsx` - Complete rewrite (WAV recording, async polling)
- `frontend/components/search/HumButton.tsx` - Enhanced styling
- `backend/src/index.ts` - Added hum-search endpoint, job status endpoint, increased payload limit
- `backend/src/services/melodyService.ts` - Enhanced logging, fixed fetch polyfill
- `frontend/tailwind.config.ts` - New animations

### Current Blocker: Testing Needed

**What's Ready:**
- ✅ All code written and type-checking passes
- ✅ Async processing implemented
- ✅ Error handling improved
- ✅ Production backend URL fallback added

**What Needs Testing:**
- ⏳ End-to-end flow: Record → Process → Poll → Results
- ⏳ Verify BasicPitch works on Railway (model loading)
- ⏳ Verify job queue persists across requests
- ⏳ Check Railway logs for processing times

### Next Steps (Tomorrow)

1. **Push latest fixes** (TypeScript errors fixed, need to commit/push)
2. **Test async processing** - Verify polling works, check Railway logs
3. **Performance optimization** (if needed):
   - Consider reducing audio sample rate further
   - Or implement faster pitch detection algorithm
   - Or use GPU-accelerated TensorFlow (if Railway supports)
4. **Error handling** - Add better user feedback for long processing times
5. **Consider alternatives** if BasicPitch is too slow:
   - Simpler autocorrelation-based pitch detection
   - Pre-process audio to reduce complexity
   - Use a different ML model (lighter weight)

### Technical Notes

- **BasicPitch is slow**: Pure JS TensorFlow.js on CPU takes 30-60s for 5 seconds of audio
- **Async pattern**: Prevents timeout but doesn't solve speed issue
- **Job queue**: In-memory (not persistent) - jobs lost on server restart
- **Production consideration**: May need Redis or database-backed queue for production

### Git Status

- Commits ready but not pushed (network issues):
  - `07be268` - Async job queue implementation
  - `e931c2f` - Lint fixes (generics)
  - Latest: TypeScript fix (not yet committed)

---

## Landing Page Redesign with Spline 3D Background

### What We Accomplished Today

#### 1. Spline 3D Integration ✅
- **Replaced React Component with Web Component**: Switched from `@splinetool/react-spline` to `<spline-viewer>` web component
- **New Spline Design**: Integrated cursor-follow effect design (`https://prod.spline.design/kzdIEyudaZu1oiNQ/scene.splinecode`)
- **Component Created**: `frontend/components/SplineViewer.tsx` - Wrapper component that loads Spline script dynamically
- **Removed Dependencies**: Removed `@splinetool/react-spline` and `@splinetool/runtime` from package.json

#### 2. Header Enhancements ✅
- **Logo Updates**: 
  - Replaced with new transparent gradient logo (3 versions tested)
  - Increased logo size to 56x56px (w-14 h-14) on home page, 48x48px on other pages
  - Increased header height from h-20 to h-24 to match Superlist design
- **Glass Effect**: 
  - Implemented glassmorphism with `backdrop-blur-md` and `bg-black/25` for seamless merge with hero section
  - Smooth animations (fade-in, slide-down) using Framer Motion
  - Navigation links styled with `text-white/80` for better visibility
- **Seamless Merge**: Header background blends perfectly with Spline hero section background

#### 3. Hero Section Updates ✅
- **Removed UI Mockup Placeholder**: Removed the 3D floating mockup image from right column
- **Spline Background**: Added Spline mouse-follow effect as background (only visible in hero section)
- **Gradient Overlays**: 
  - Top gradient (`from-black/25`) matches header for seamless merge
  - Bottom gradient (`h-80`) creates smooth transition to next section
- **Layout**: Maintained 2-column grid structure, right column now empty to show Spline background

#### 4. Footer Updates ✅
- **Logo Only**: Removed "ParLeap" text, keeping only the logo icon
- **Consistent Styling**: Logo matches header size (48x48px)

#### 5. Section Transitions ✅
- **Smooth Fade**: Added gradient overlays between HeroSection and ProblemFraming for seamless merge
- **Visual Continuity**: Sections now flow together as one unified design

#### 6. Asset Management ✅
- **UI Placeholder Archived**: Moved `live-page-mockup.png` to `frontend/public/assets/archive/ui-mockup-placeholder.png` for future use
- **Documentation Updated**: Updated `LANDING_PAGE_DESIGN.md` to reflect new asset locations

### Files Created/Modified

**New Files:**
- `frontend/components/SplineViewer.tsx` - Spline web component wrapper

**Modified Files:**
- `frontend/app/page.tsx` - Restored full component structure, added Spline background
- `frontend/app/layout.tsx` - Header component integration
- `frontend/components/layout/Header.tsx` - Complete redesign with glass effect, animations, larger logo
- `frontend/components/landing/HeroSection.tsx` - Removed mockup, added Spline background, gradient overlays
- `frontend/components/landing/ProblemFraming.tsx` - Added top fade overlay for seamless merge
- `frontend/components/layout/Footer.tsx` - Logo only (no text), matching header styling
- `frontend/package.json` - Removed Spline React dependencies
- `LANDING_PAGE_DESIGN.md` - Updated asset locations

**Moved Files:**
- `frontend/public/live-page-mockup.png` → `frontend/public/assets/archive/ui-mockup-placeholder.png`

### Design Decisions

1. **Web Component vs React Component**: Chose web component for better performance and simpler integration
2. **Glass Effect**: Used `backdrop-blur-md` with low opacity (`bg-black/25`) for perfect merge with Spline background
3. **Logo Size**: Increased to match Superlist's prominent logo design
4. **Header Height**: Increased to h-24 for better visual presence
5. **Section Merging**: Used gradient overlays instead of solid backgrounds for seamless transitions

### Technical Notes

- Spline viewer script loads dynamically via `useEffect` to avoid SSR issues
- `suppressHydrationWarning` added to `<spline-viewer>` for Next.js compatibility
- Header uses `fixed` positioning with proper z-index layering
- All animations use Framer Motion for smooth transitions
- Footer logo is clickable link to home page (consistent with header)
