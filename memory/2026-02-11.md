# Daily Log — February 11, 2026

## Session: Bible in Live Setlist + Smart Listen Fixes

### What We Did
- Investigated Bible items not showing in live setlist (showed pre-session, disappeared after Start Session)
- Identified root cause: PostgREST INNER JOIN on `songs()` embed excludes rows where `song_id IS NULL` (Bible items)
- Split backend eventService query into two separate Supabase calls (no more songs embed)
- Fixed Smart Listen gate: no longer requires `BIBLE_SMART_LISTEN_ENABLED` env var — honors client toggle
- Added frontend resilience: SetlistPanel merges missing Bible items from initialSetlist
- Added OperatorHUD local tracking of currentItemIsBible (from clicks, not just backend messages)
- Added temporary debug endpoint `/api/debug/event-items/:eventId`
- All changes pushed to production (CI passed)

### Current Status
- **NOT FULLY WORKING** — user reports Bible still not visible after deploy
- Need to test debug endpoint to isolate whether issue is backend (Supabase query) or frontend (rendering)
- Paused work — will resume in next session

### Key Commits
- `3097cd0` — fix: Bible items excluded by PostgREST INNER JOIN + Smart Listen gate
- `b435214` — chore: add debug endpoint for event_items diagnosis

### Debugging Plan for Next Session
1. User tests: `https://parleapbackend-production.up.railway.app/api/debug/event-items/EVENT_ID`
2. If Bible item appears in JSON → issue is frontend merge/rendering
3. If Bible item missing → issue is Supabase query or data
4. Check browser console for `[SetlistPanel] Merging` and `[EventService] Fetched` logs
5. Try `NOTIFY pgrst, 'reload schema'` in Supabase SQL editor to force PostgREST cache refresh

### Lessons
- PostgREST schema cache can cause INNER JOIN even after `DROP NOT NULL` — always verify with direct queries
- When debugging production, add diagnostic endpoints early rather than guessing
- The `BIBLE_SMART_LISTEN_ENABLED` env var design was wrong (opt-in → should be kill-switch)

---

## Session: Bible Follow, Parsing, and STT Stability

### What We Did
- Added **Bible passage auto-follow** after explicit reference, with a **“Following” badge + Stop button** in Operator HUD.
- Improved **matcher recovery** when stuck at low confidence (temporary backward window) and prevented STT confidence display from sticking at 0%.
- Expanded **Bible reference parsing** to handle natural phrasing:
  - “Luke chapter 2 verse 1”
  - “Romans chapter 4 verse 5 to 15”
  - “Luke 2:1”, “Luke 2 verses 1–3”, etc.
- Lint fix for regex escape in bible parser.

### Key Commits
- `a60e359` — fix: recover matcher after stall and guard STT 0%
- `ce79927` — feat: auto-follow bible passages after reference
- `47e25c8` — feat: expand bible reference parsing variants
- `d7be9f5` — fix: appease eslint regex escape

---

## Session: Smart Listen gating + mic issues (reverted) + Psalms alias

### What We Did
- Adjusted Smart Listen: Bible mode off keeps songs continuous; gate applies only to non-song items when Bible mode is on.
- Tried broader getUserMedia fallbacks (deviceId/default/explicit). Reverted them after "Requested device not found" errors; restored prior mic logic.
- Added Psalms mis-hear aliases (`sams`, `salms`) so STT “sams/salms” maps to Psalms.

### Key Commits
- `bf08290` — keep songs continuous when Bible mode off; gate non-songs only in Bible mode.
- `a0986ae`, `a66f615`, `8621795` — revert mic fallback experiments.
- `b650ba7` — add Psalms mis-hearing aliases.
