# Daily Log — February 19, 2026

## Session: Railway backend build fix + docs/memory update

### What we did

**1. Railway backend build**
- Root cause: Nixpacks runs build in non-login shell → `tsc` not on PATH; `npx tsc` / `npx -p typescript tsc` used wrong package or separate TS without project node_modules → TS7016 (missing @types), TS7006 (implicit any). Also `node ../node_modules/typescript/bin/tsc` failed because TypeScript was only in devDependencies and Railway doesn’t install devDependencies.
- Fixes: (1) Build script uses `node ../node_modules/typescript/bin/tsc`. (2) typescript + @types/express, @types/cors, @types/string-similarity moved to dependencies. (3) backend/src/index.ts: all Express handlers typed with Request, Response, NextFunction.
- Result: Backend builds on Railway; local and CI pass.

**2. Documentation**
- RAILWAY_FIX.md: added section “Railway Backend Build Fix (February 19, 2026)” with problem, solution, result, and “don’t revert to” notes.
- MEMORY.md: new session entry for Feb 19 (Railway backend build fix, lesson, docs).
- .cursor/rules/project-context.mdc: added note under deployment/backend about TypeScript + @types in dependencies and build script.

**3. Memory**
- MEMORY.md updated with session summary and key lesson.
- memory/2026-02-19.md created (this file).

### Files changed
- backend/package.json — build/type-check scripts, typescript + @types in dependencies
- backend/src/index.ts — Express types, typed handlers
- RAILWAY_FIX.md — new backend build fix section
- MEMORY.md — Feb 19 session
- .cursor/rules/project-context.mdc — backend build note
- memory/2026-02-19.md — new

---

## Session: Decouple Live from setlist + Bible Mode STT fix

### What we did

**1. Decouple Live Engine From Setlist Order**
- Setlist is operator overview only; order does not control live matching.
- **Transcript routing**: Bible path only when `session.bibleMode` is true and (ref in transcript or `session.bibleFollow`). No routing by current setlist item type.
- **Bible triggers**: Only when Bible Mode is ON (operator toggle); no random Bible verse during singing when Bible Mode off.
- **Smart Listen (backend)**: `shouldUseSmartListenGate(session)` uses only kill switch + `smartListenEnabled` + `bibleMode` (no setlist item type).
- **Smart Listen (frontend)**: Was `effectiveSmartListen = master && bibleMode`; later changed (see below).
- **Match stability**: Song switch needs 3 sustained matches, min confidence 0.58; `session.currentLineIndex` set on auto-switch; backward block uses `effectiveCurrentLine` (session + songContext).
- **SESSION_STARTED**: Payload uses `session.currentSongIndex` / `session.currentSlideIndex` (fixes disordered setlist).
- **Tests**: Unit tests for bibleMode true/false and disordered setlist `currentSongIndex`.

**2. Lint and type-check fixes**
- Backend: Removed unused `currentItemType()` in handler.ts (ESLint no-unused-vars).
- Frontend: Removed unused `isSongLikeItem`, `resolveActiveItemType`, `currentItemIndex`/`activeItemType` state and sync effect, `isDisplayUpdateMessage`, `useSlideCache`/`slideCache` (TS6133).

**3. Bible Mode on = STT continuous (no standby)**
- When Bible Mode was ON, Smart Listen gate was on → STT showed "Standby (Smart Listen)" and AI did not listen until wake word / "Listen now".
- **Change**: `effectiveSmartListen = smartListenMasterEnabled && !bibleMode`. So when Bible Mode is ON, we do not gate; STT stays continuous and AI listens for verse references (e.g. "John 3 16").
- Smart Listen standby only when Bible Mode is OFF and master is On. Updated Smart Listen button labels/tooltips.

### Files changed (this session)
- backend/src/websocket/handler.ts — routing by bibleMode only, remove currentItemType, Smart Listen gate, match stability, SESSION_STARTED payload
- frontend/components/operator/OperatorHUD.tsx — Smart Listen by bibleMode only then Bible-on = no gate; remove unused state/imports
- backend/src/__tests__/unit/websocket.test.ts — Decouple tests (bibleMode, disordered setlist)
