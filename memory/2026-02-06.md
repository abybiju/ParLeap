# Daily Memory - February 6, 2026

## Morning Session: Smart Bible Listen Feature Discussion & Documentation

### Feature Design Discussion
User raised concern about STT costs in Bible mode for long sermons (40+ minutes). Discussed solution for cost optimization while maintaining accuracy.

**User's Concern:**
- "I don't want my AI token to get finished by listening to all of his words"
- STT runs continuously in Bible mode, accumulating costs
- Want to only activate STT when Bible-related content detected

**Challenge Identified:**
- Can't detect Bible content without STT running (chicken-and-egg problem)
- Need lightweight way to "wake up" system before activating expensive STT

### Solution: Smart Bible Listen (Two-Stage Hybrid System)

**Stage 1: Local Wake-Word Detection (Zero API Cost)**
- Runs in browser (frontend)
- Pattern matching on audio chunks before sending to backend
- Detects Bible book names, wake phrases ("chapter", "verse", "it is written")
- Maintains 10-second audio ring buffer
- No API cost - runs entirely locally

**Stage 2: Selective STT Window (Controlled Cost)**
- Activates ElevenLabs STT only when wake word detected
- Sends ring buffer (last 10s) + next 30s to STT
- If Bible reference found → keep STT active for follow mode
- If no reference found after 30s → shut STT off

**Cost Savings:**
- 40-minute sermon: 2,400 seconds → ~300 seconds (87-93% reduction)
- Example: 5-10 Bible references × 30s each = 150-300 seconds

### Quote-Only Detection Discussion

**User's Request:**
- Detect verses from quotes only (e.g., "weeping and gnashing of teeth")
- Even when book name not mentioned

**Technical Opinion:**
- Quote-only matching is expensive (requires full-text search across all ~31,000 verses)
- STT must be running to get quote text
- High computational cost (fuzzy matching)

**Decision:**
- Make quote-only matching **opt-in only** (disabled by default)
- Toggle: "Quote Search Mode" in Operator HUD
- Show warning: "Quote search uses more API credits"
- Only search after Bible reference detected (provides context)

### User Preferences Captured

1. **Default Behavior**: Smart Listen ON by default when Bible mode is on
2. **STT Window**: 30 seconds after wake word detected
3. **Quote Matching**: Opt-in only (disabled by default)
4. **Ring Buffer**: 10 seconds of audio context
5. **Cost Indicator**: Show savings in UI ("Saved: X seconds of STT")

### Documentation Created

**Files Created:**
- `SMART_BIBLE_LISTEN.md` - Complete feature specification
  - Problem statement
  - Solution architecture
  - Technical design details
  - Implementation checklist
  - Cost savings analysis
  - Architecture diagrams

**Files Updated:**
- `PROJECT_PLAN.md` - Added Future Features section with Smart Bible Listen
- `NEXT_PHASE_PLAN.md` - Added Phase 8: Smart Bible Listen
- `MEMORY.md` - Added February 6, 2026 entry

### Bible Service Enhancement

**Change Made:**
- Added bidirectional book lookup cache (`byId` map)
- Enables O(1) reverse lookups by book ID
- Previously only had `byName` lookup

**Commit:**
- `ae0d81a` - "feat: add bidirectional book lookup cache in bible service"
- Pushed to production

**Files Modified:**
- `backend/src/services/bibleService.ts`

---

## Afternoon Session: Event Management UI with Polymorphic Setlist - Bug Fixes

### Issues Fixed

1. **TypeScript Type-Check Errors** ✅
   - **Problem**: Multiple TypeScript errors preventing builds
   - **Errors Fixed**:
     - Unused `isPending` variable in `SetlistBuilder.tsx`
     - Unused type imports in `SetlistItemCard.tsx` and `SetlistLibrary.tsx`
     - Duplicate `SetlistItemData` import in `handler.ts`
     - Type casting issues in `eventService.ts` (needed `as unknown as` pattern)
   - **Files Modified**:
     - `frontend/components/events/SetlistBuilder.tsx`
     - `frontend/components/events/SetlistItemCard.tsx`
     - `frontend/components/events/SetlistLibrary.tsx`
     - `backend/src/websocket/handler.ts`
     - `backend/src/services/eventService.ts`
   - **Commit**: `7688fd6` - "fix: resolve TypeScript type-check errors"

2. **Duplicate Key Constraint Violation (Drag-and-Drop)** ✅
   - **Problem**: Error "duplicate key value violates unique constraint event_items_event_id_sequence_order_key" when reordering items
   - **Root Cause**: Parallel updates created temporary duplicate `sequence_order` values
   - **Solution**: Two-phase sequential update approach
     - Phase 1: Set all items to unique temporary values (`10000 + index`)
     - Phase 2: Update to final sequence_order values
   - **Additional**: Created PostgreSQL function `reorder_event_items()` for atomic updates (preferred method)
   - **Files Modified**:
     - `frontend/app/events/actions.ts` - Updated `reorderEventItems()` function
     - `supabase/migrations/011_add_polymorphic_setlist_items.sql` - Added `reorder_event_items()` function
   - **Commits**: 
     - `09c3b8f` - "fix: resolve setlist drag-and-drop and Bible/Media item issues"
     - `69250ba` - "fix: prevent duplicate key violations during drag-and-drop reorder"

3. **Null song_id Constraint Violation (Bible/Media Items)** ✅
   - **Problem**: Error "null value in column 'song_id' violates not-null constraint" when adding Bible/Media items
   - **Root Cause**: Migration didn't make `song_id` nullable for polymorphic items
   - **Solution**: Added `ALTER COLUMN song_id DROP NOT NULL` to migration
   - **Files Modified**:
     - `supabase/migrations/011_add_polymorphic_setlist_items.sql`
   - **Commit**: `09c3b8f` - "fix: resolve setlist drag-and-drop and Bible/Media item issues"

4. **Setlist Items Not Loading in Live Session** ⚠️ (Partial Fix)
   - **Problem**: Setlist items (SONG, BIBLE, MEDIA) saved in event not appearing in live session
   - **Root Cause**: Backend fetched `setlistItems` but didn't include them in `SESSION_STARTED` message
   - **Solution Applied**:
     - Added `setlistItems` to `SESSION_STARTED` message payload (backend & frontend types)
     - Backend now sends `setlistItems` in response
     - Frontend `slideCache` stores `setlistItems`
     - Updated live page query to support polymorphic items
   - **Files Modified**:
     - `backend/src/types/websocket.ts` - Added `setlistItems` to `SessionStartedMessage`
     - `backend/src/websocket/handler.ts` - Include `setlistItems` in response
     - `frontend/lib/websocket/types.ts` - Added `setlistItems` to type
     - `frontend/lib/stores/slideCache.ts` - Store `setlistItems` in cache
     - `frontend/lib/hooks/useWebSocket.ts` - Pass `setlistItems` when caching
     - `frontend/app/live/[id]/page.tsx` - Updated query for polymorphic support
   - **Commit**: `8d91e41` - "fix: include polymorphic setlistItems in live session"
   - **Status**: ⚠️ Fix applied but user reports still not working - needs further investigation tomorrow

### Commits Summary

1. `7688fd6` - "fix: resolve TypeScript type-check errors"
2. `09c3b8f` - "fix: resolve setlist drag-and-drop and Bible/Media item issues"
3. `69250ba` - "fix: prevent duplicate key violations during drag-and-drop reorder"
4. `8d91e41` - "fix: include polymorphic setlistItems in live session"

### Files Modified Today

**Backend:**
- `backend/src/services/bibleService.ts` (morning - bidirectional cache)
- `backend/src/services/eventService.ts` (type casting fixes)
- `backend/src/websocket/handler.ts` (duplicate import fix, setlistItems in response)
- `backend/src/types/websocket.ts` (setlistItems in SessionStartedMessage)

**Frontend:**
- `frontend/components/events/SetlistBuilder.tsx` (unused variable fix)
- `frontend/components/events/SetlistItemCard.tsx` (unused imports fix)
- `frontend/components/events/SetlistLibrary.tsx` (unused imports fix)
- `frontend/app/events/actions.ts` (reorderEventItems sequential updates)
- `frontend/app/live/[id]/page.tsx` (polymorphic query support)
- `frontend/lib/websocket/types.ts` (setlistItems in SessionStartedMessage)
- `frontend/lib/stores/slideCache.ts` (store setlistItems)
- `frontend/lib/hooks/useWebSocket.ts` (pass setlistItems to cache)

**Database:**
- `supabase/migrations/011_add_polymorphic_setlist_items.sql` (song_id nullable, reorder function)

### Outstanding Issues

1. **Setlist Items Not Showing in Live Session** ⚠️
   - Fix applied but user reports still not working
   - Needs investigation: Check if migration was run, verify data flow, check frontend display logic
   - Next steps: Debug why setlistItems aren't appearing despite being sent in SESSION_STARTED

### Next Steps (Tomorrow)

1. Debug setlist items not appearing in live session
   - Verify migration `011_add_polymorphic_setlist_items.sql` was run
   - Check browser console logs for `setlistItems` in SESSION_STARTED message
   - Verify `slideCache.setlist.setlistItems` contains data
   - Check if `SetlistPanel` component needs update to display non-song items

2. Test drag-and-drop reordering
   - Verify duplicate key error is resolved
   - Test with multiple items
   - Verify PostgreSQL function works (if migration run)

3. Test Bible/Media item creation
   - Verify null song_id error is resolved
   - Test adding Bible references
   - Test adding Media items
