# Daily Memory - February 3, 2026

## Profile Settings + Avatar System (Presets + Device Upload)

### What shipped
- **Profile Settings page**: Sidebar tabs (General / Account / Security / Billing) at `frontend/app/dashboard/profile/page.tsx`, with Back-to-Dashboard nav.
- **Avatar selection**:
  - Preset emoji avatars (e.g. `rocket`, `planet`)
  - Preset image avatars stored under `frontend/public/avatars/presets/*` and saved as `preset:*` IDs
  - Device upload via Supabase Storage (bucket: `avatars`) saved as a public URL
- **UI polish**:
  - Fixed invisible outline-button text issues (notably ‚ÄúCancel‚Äù and ‚ÄúReset Password‚Äù)
  - Added subtle orange hover glow to Profile cards to match the brand vibe
  - `DashboardHeader` now renders the current avatar (preset image / emoji / uploaded URL) instead of always showing initials

### Supabase operational notes
- If the app errors with: `Could not find the 'avatar' column of 'profiles' in the schema cache`:
  - Ensure `public.profiles.avatar` exists (run migration SQL if needed)
  - Reload PostgREST schema cache (fallback SQL: `select pg_notify('pgrst', 'reload schema');`)
- Device uploads require:
  - Public Storage bucket `avatars`
  - RLS policies from `supabase/migrations/005_setup_avatar_storage.sql`

### CI/CD gotchas encountered
- Vercel + `tsc --noEmit` will fail on **unused vars/params**; fixed by removing unused destructuring and prefixing unused params with `_`.
- `next/image` does not reliably support `blob:` previews and external URLs without config; used `<img>` for those cases.

### GitHub push blocker
- Push failures occurred due to machine/network/credential issues:
  - DNS: `Could not resolve host: github.com`
  - Credentials: `could not read Username for 'https://github.com': Device not configured`
- Workaround: push from local machine with proper auth (PAT/SSH or `gh auth login`).

---

## Live Session Fixes - Multi-line Projection & Audio Issues

### Working State (Before Display Fix)
‚úÖ **Audio Pipeline**: PCM 16-bit audio streaming to ElevenLabs STT
- Buffer size: 2048 samples (128ms latency, ~8 chunks/sec)
- Fixes RATE_LIMITED error (previous 256 samples = 62 chunks/sec)
- Commit: `9648ef8` - Fix RATE_LIMITED error

‚úÖ **Auto-Switch Threshold**: Lowered from 85% to 50%
- Any song match ‚â•50% confidence auto-switches (after 2 sustained matches)
- <50% confidence shows suggestion toast only
- Applies to ALL songs in setlist universally
- Commit: `ca8029e` - Lower auto-switch threshold

‚úÖ **Audio Capture**: Using `AudioContext` + `ScriptProcessorNode`
- Format: Linear PCM 16-bit (pcm_s16le), 16kHz, mono
- Session-aware sending: Only sends audio when `sessionActive=true`
- Uses `useRef` for `sessionActiveRef` to prevent stale closures

‚úÖ **Live Transcription**: Working correctly
- Backend broadcasts `TRANSCRIPT_UPDATE` to all event clients
- GhostText component always renders, shows "Listening..." when no transcript
- Transcripts appearing in operator HUD

‚úÖ **Next Slide Preview**: Shows 4 lines correctly (see screenshot)

### Issue: Main Slide Shows 1 Line (FIXED ‚úÖ)
**Root Cause**: Auto-switch DISPLAY_UPDATE missing `slideLines` and `slideText`

**Fix Applied** (Commit `32b443c`):
- Modified `backend/src/websocket/handler.ts` auto-switch logic (line 556-591)
- Now fetches full slide data: `session.songs[songIndex].slides[slideIndex]`
- Sends complete `slideLines` (array) and `slideText` (multi-line) in DISPLAY_UPDATE
- Added debug logging: "üì§ Sending DISPLAY_UPDATE for auto-switch: X lines"

**Result**: All slide display scenarios now show 4 lines correctly:
- ‚úÖ Session start (was working)
- ‚úÖ Manual override (was working)
- ‚úÖ Auto-switch (NOW FIXED!)

---

### Issue: Next Slide Preview Cut Off (FIXED ‚úÖ)
**Root Cause**: 4-line display with large fonts consumed too much vertical space

**Layout Optimizations** (Commit `05240c1`):

**CurrentSlideDisplay.tsx**:
- Font size: `text-5xl` ‚Üí `text-3xl` (48px ‚Üí 30px on large screens)
- Padding: `p-8` ‚Üí `py-4 px-4` (32px ‚Üí 16px vertical)
- Line spacing: `space-y-3` ‚Üí `space-y-1.5` (12px ‚Üí 6px)
- Margins: `mb-6/mt-6` ‚Üí `mb-3/mt-2` (24px ‚Üí 12px/8px)
- Leading: `leading-relaxed` ‚Üí `leading-snug`

**NextSlidePreview.tsx**:
- Font size: `text-lg` ‚Üí `text-sm` (18px ‚Üí 14px)
- Padding: `p-4` ‚Üí `p-3` (16px ‚Üí 12px)
- Line spacing: `space-y-1` ‚Üí `space-y-0.5` (4px ‚Üí 2px)
- Top margin: `mt-6` ‚Üí `mt-4` (24px ‚Üí 16px)

**OperatorHUD.tsx**:
- Container padding: `p-6` ‚Üí `p-4` (24px ‚Üí 16px)
- Overflow: `overflow-hidden` ‚Üí `overflow-y-auto` (scrollable if needed)

**Space Saved**: ~200px vertical space
**Result**: Both current slide (4 lines) + next slide preview now fit on screen

**Safety**: Revert to commit `6683919` if layout breaks

---

### Issue: Stop Button Hidden by Navigation (FIXED ‚úÖ)
**Root Cause**: OperatorHUD container didn't account for fixed DashboardHeader positioning

**Fix Applied** (Commit `78f96b9`):
- Main container: `h-[calc(100vh-6rem)]` ‚Üí `min-h-screen pt-16`
- Added `pt-16` (64px) top padding to match fixed header height
- Header padding: `py-4` ‚Üí `py-3` (more compact)
- Added `z-40` to internal header
- Added `min-h-0` to three-panel grid (prevents overflow)
- Event name: `text-xl` ‚Üí `text-lg` + `truncate` (prevents text overflow)
- Buttons container: Added `ml-auto` (proper right alignment)

**Result**: Stop Session button and all header controls now fully visible

---

## Session Summary - February 3, 2026 (Evening)

### All Issues Resolved ‚úÖ

**1. Audio Streaming (RATE_LIMITED Error)**
- Problem: 256-sample buffer = 62 chunks/sec ‚Üí rate limit
- Fix: Buffer size increased to 2048 samples (128ms latency, 8 chunks/sec)
- Status: ‚úÖ Working - No more rate limit errors

**2. Auto-Switch Threshold** 
- Problem: 85% threshold too strict (84% match showed suggestion instead of auto-switching)
- Fix: Lowered to 50% threshold - auto-switches at any reasonable confidence
- Status: ‚úÖ Working - AI switches immediately at 50%+ confidence

**3. Multi-Line Display on Auto-Switch**
- Problem: Only 1 line shown when AI auto-switched songs
- Root cause: Missing `slideLines` and `slideText` in auto-switch DISPLAY_UPDATE
- Fix: Backend now fetches and sends full slide data during auto-switch
- Status: ‚úÖ Working - All 4 lines display correctly

**4. Layout Overflow (Next Slide Hidden)**
- Problem: 4 lines with large fonts pushed next slide preview off screen
- Fix: Reduced font sizes, padding, spacing across all components (~200px saved)
- Status: ‚úÖ Working - Both current slide and next slide visible

**5. Stop Button Hidden by Header**
- Problem: Fixed navigation header overlapping Stop Session button
- Fix: Added `pt-16` top padding to account for fixed header height
- Status: ‚úÖ Working - All buttons fully visible

### Current Working Configuration

**Audio System**:
- Format: PCM 16-bit (pcm_s16le), 16kHz, mono
- Buffer: 2048 samples (128ms latency)
- Message rate: ~8 chunks/sec (prevents rate limiting)
- Session-aware: Only sends when `sessionActive=true`

**Matching System**:
- Auto-switch threshold: 50% confidence
- Debouncing: 2 sustained matches required
- Cooldown: 3 seconds between song switches
- Current song priority: Checked first (optimization)
- **End-of-line detection**: Last 40% of words trigger advance (65% confidence)
- **Forward-only constraint**: Never allows backward progression (prevents repeated lyrics backtracking)

**Display Layout**:
- Main slide: `text-3xl` font, `py-4 px-4` padding, 4 lines visible
- Next slide: `text-sm` font, compact spacing, fully visible
- Header: 64px fixed height with proper padding accounted for
- All controls accessible (Auto-Follow, Status, Stop Session)

### Commits Created (Ready to Push)
1. `9648ef8` - Fix RATE_LIMITED error (buffer 2048)
2. `ca8029e` - Lower auto-switch threshold (85% ‚Üí 50%)
3. `11cc8a7` - Document display bug analysis (safe point)
4. `32b443c` - Fix auto-switch multi-line display
5. `6683919` - Update memory (display fix)
6. `05240c1` - Optimize layout spacing
7. `6510991` - Document layout optimizations
8. `78f96b9` - Fix Stop button overlap
9. `45f7b03` - Document header fix

### Files Modified
**Backend**:
- `backend/src/websocket/handler.ts` - Auto-switch display data fix

**Frontend**:
- `frontend/components/operator/CurrentSlideDisplay.tsx` - Font/spacing optimization
- `frontend/components/operator/NextSlidePreview.tsx` - Font/spacing optimization
- `frontend/components/operator/OperatorHUD.tsx` - Layout fixes (padding, overflow)
- `frontend/lib/hooks/useAudioCapture.ts` - Buffer size adjustment (256 ‚Üí 2048)

**Documentation**:
- `memory/2026-02-03.md` - Session documentation

### Ready for Production
All changes tested and working. Safe to deploy to Railway.

**Revert Points (If Needed)**:
- Full session: Revert to commit `6683919` (before layout changes)
- Layout only: Revert to commit `05240c1` (before header fix)

---

## Session Summary - February 3, 2026 (Late Evening) - Advanced Matching Features

### New Features Implemented ‚úÖ

**6. End-of-Line Detection for Faster Slide Advance** ‚úÖ
- Problem: AI waited for NEXT line to start before advancing (too slow)
- Solution: Detect LAST 40% of words in current line, advance immediately
- Configuration: 40% of line length (adapts to short/long lines), 65% confidence threshold
- Result: Slides advance ~500-1000ms faster, right when singer finishes verse
- Commits: `501a554`, `1e9d504`, `a392b8b`

**7. Forward-Only Constraint (Repeated Lyrics Fix)** ‚úÖ
- Problem: Songs with repeated lyrics (e.g., "He will make a way for me" at end of each stanza) caused backward jumps
- Solution: Strict forward-only progression - never allow matches < currentLineIndex
- Protection layers:
  1. Matcher level: Rejects backward line matches
  2. Handler level: Blocks backward slide changes
  3. Manual overrides: PREV button still works (bypasses constraint)
- Result: System never jumps backward, handles repeated lyrics correctly
- Commit: `5603869`

### Updated Matching Configuration

**End-of-Line Detection**:
- Trigger: Last 40% of words in current line
- Confidence: 65% threshold
- Examples:
  - Short line (6 words): Last 3 words trigger
  - Medium line (10 words): Last 4 words trigger
  - Long line (15 words): Last 6 words trigger

**Forward-Only Progression**:
- Matcher: Only accepts matches >= currentLineIndex
- Handler: Blocks slide changes where newSlideIndex < currentSlideIndex
- Manual navigation: PREV button bypasses constraint (user intent)
- Debug logging: Comprehensive diagnostics for troubleshooting

### Files Modified (Latest Session)

**Backend**:
- `backend/src/services/matcherService.ts`
  - Added `extractEndWords()` helper (percentage-based)
  - Added end-of-line detection logic
  - Added forward-only constraint validation
  - Added `wasForwardProgress` field to MatchResult
  
- `backend/src/websocket/handler.ts`
  - Added slide-level backward protection
  - Enhanced error logging for blocked backward jumps

### Testing Results

**End-of-Line Detection**:
- ‚úÖ Faster slide transitions (~500-1000ms improvement)
- ‚úÖ Works with varying line lengths (adaptive percentage)
- ‚úÖ 65% threshold provides good balance (not too strict, not too loose)

**Forward-Only Constraint**:
- ‚úÖ Prevents backward jumps with repeated lyrics
- ‚úÖ "God will make a way" song now works correctly
- ‚úÖ Manual PREV button still functional
- ‚úÖ No false positives observed

### Next Steps (Future)
- Monitor ElevenLabs connection stability in production
- Consider AudioWorklet migration (ScriptProcessor is deprecated but still works)
- Test with longer songs (17+ slides like "God will make a way")
- Verify low latency (<300ms end-to-end) in production environment
- Consider making end-of-line percentage configurable per-song

