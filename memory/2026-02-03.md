# Daily Memory - February 3, 2026

## Profile Settings + Avatar System (Presets + Device Upload)

### What shipped
- **Profile Settings page**: Sidebar tabs (General / Account / Security / Billing) at `frontend/app/dashboard/profile/page.tsx`, with Back-to-Dashboard nav.
- **Avatar selection**:
  - Preset emoji avatars (e.g. `rocket`, `planet`)
  - Preset image avatars stored under `frontend/public/avatars/presets/*` and saved as `preset:*` IDs
  - Device upload via Supabase Storage (bucket: `avatars`) saved as a public URL
- **UI polish**:
  - Fixed invisible outline-button text issues (notably “Cancel” and “Reset Password”)
  - Added subtle orange hover glow to Profile cards to match the brand vibe
  - `DashboardHeader` now renders the current avatar (preset image / emoji / uploaded URL) instead of always showing initials

### Supabase operational notes
- If the app errors with: `Could not find the 'avatar' column of 'profiles' in the schema cache`:
  - Ensure `public.profiles.avatar` exists (run migration SQL if needed)
  - Reload PostgREST schema cache (fallback SQL: `select pg_notify('pgrst', 'reload schema');`)
- Device uploads require:
  - Public Storage bucket `avatars`
  - RLS policies from `supabase/migrations/005_setup_avatar_storage.sql`

### CI/CD gotchas encountered
- Vercel + `tsc --noEmit` will fail on **unused vars/params**; fixed by removing unused destructuring and prefixing unused params with `_`.
- `next/image` does not reliably support `blob:` previews and external URLs without config; used `<img>` for those cases.

### GitHub push blocker
- Push failures occurred due to machine/network/credential issues:
  - DNS: `Could not resolve host: github.com`
  - Credentials: `could not read Username for 'https://github.com': Device not configured`
- Workaround: push from local machine with proper auth (PAT/SSH or `gh auth login`).

---

## Live Session Fixes - Multi-line Projection & Audio Issues

### Working State (Before Display Fix)
✅ **Audio Pipeline**: PCM 16-bit audio streaming to ElevenLabs STT
- Buffer size: 2048 samples (128ms latency, ~8 chunks/sec)
- Fixes RATE_LIMITED error (previous 256 samples = 62 chunks/sec)
- Commit: `9648ef8` - Fix RATE_LIMITED error

✅ **Auto-Switch Threshold**: Lowered from 85% to 50%
- Any song match ≥50% confidence auto-switches (after 2 sustained matches)
- <50% confidence shows suggestion toast only
- Applies to ALL songs in setlist universally
- Commit: `ca8029e` - Lower auto-switch threshold

✅ **Audio Capture**: Using `AudioContext` + `ScriptProcessorNode`
- Format: Linear PCM 16-bit (pcm_s16le), 16kHz, mono
- Session-aware sending: Only sends audio when `sessionActive=true`
- Uses `useRef` for `sessionActiveRef` to prevent stale closures

✅ **Live Transcription**: Working correctly
- Backend broadcasts `TRANSCRIPT_UPDATE` to all event clients
- GhostText component always renders, shows "Listening..." when no transcript
- Transcripts appearing in operator HUD

✅ **Next Slide Preview**: Shows 4 lines correctly (see screenshot)

### Current Issue (To Fix)
❌ **Main Slide Display**: Shows only 1 line instead of 4 lines
- Screenshot evidence: Slide 1 shows "Amazing grace how sweet the sound" (1 line)
- Next Slide preview correctly shows 4 lines: "O Lord my God when I in awesome wonder..."

### Root Cause Analysis ✅
**Problem**: In `backend/src/websocket/handler.ts`, when auto-switching songs (line 557-568):
- The DISPLAY_UPDATE message only sends `lineText` (single line)
- Missing: `slideLines` (array) and `slideText` (multi-line string)

**Evidence**:
```typescript
// ❌ AUTO-SWITCH: Only sends lineText
const displayMsg: DisplayUpdateMessage = {
  type: 'DISPLAY_UPDATE',
  payload: {
    lineText: suggestion.matchedLine,  // Single line only!
    slideIndex: suggestion.matchedLineIndex,
    // Missing: slideLines, slideText
  }
};

// ✅ SESSION_STARTED: Sends full slide data (line 365-377)
payload: {
  lineText: currentSlide.lines[0],
  slideText: currentSlide.slideText,  // Multi-line text
  slideLines: currentSlide.lines,      // Array of lines
}
```

**Fix Strategy**:
1. In auto-switch logic, get full slide data from `session.songs[suggestion.songIndex]`
2. Send complete `slideLines` and `slideText` in DISPLAY_UPDATE
3. Test: Auto-switch should show 4 lines, not 1 line

### Safety Protocol
- Document current working state FIRST ✅
- Root cause analysis DONE ✅
- Create backup commit before changes
- If anything breaks, revert to commit `ca8029e`

