# Daily Memory - February 3, 2026

## Profile Settings + Avatar System (Presets + Device Upload)

### What shipped
- **Profile Settings page**: Sidebar tabs (General / Account / Security / Billing) at `frontend/app/dashboard/profile/page.tsx`, with Back-to-Dashboard nav.
- **Avatar selection**:
  - Preset emoji avatars (e.g. `rocket`, `planet`)
  - Preset image avatars stored under `frontend/public/avatars/presets/*` and saved as `preset:*` IDs
  - Device upload via Supabase Storage (bucket: `avatars`) saved as a public URL
- **UI polish**:
  - Fixed invisible outline-button text issues (notably ‚ÄúCancel‚Äù and ‚ÄúReset Password‚Äù)
  - Added subtle orange hover glow to Profile cards to match the brand vibe
  - `DashboardHeader` now renders the current avatar (preset image / emoji / uploaded URL) instead of always showing initials

### Supabase operational notes
- If the app errors with: `Could not find the 'avatar' column of 'profiles' in the schema cache`:
  - Ensure `public.profiles.avatar` exists (run migration SQL if needed)
  - Reload PostgREST schema cache (fallback SQL: `select pg_notify('pgrst', 'reload schema');`)
- Device uploads require:
  - Public Storage bucket `avatars`
  - RLS policies from `supabase/migrations/005_setup_avatar_storage.sql`

### CI/CD gotchas encountered
- Vercel + `tsc --noEmit` will fail on **unused vars/params**; fixed by removing unused destructuring and prefixing unused params with `_`.
- `next/image` does not reliably support `blob:` previews and external URLs without config; used `<img>` for those cases.

### GitHub push blocker
- Push failures occurred due to machine/network/credential issues:
  - DNS: `Could not resolve host: github.com`
  - Credentials: `could not read Username for 'https://github.com': Device not configured`
- Workaround: push from local machine with proper auth (PAT/SSH or `gh auth login`).

---

## Live Session Fixes - Multi-line Projection & Audio Issues

### Working State (Before Display Fix)
‚úÖ **Audio Pipeline**: PCM 16-bit audio streaming to ElevenLabs STT
- Buffer size: 2048 samples (128ms latency, ~8 chunks/sec)
- Fixes RATE_LIMITED error (previous 256 samples = 62 chunks/sec)
- Commit: `9648ef8` - Fix RATE_LIMITED error

‚úÖ **Auto-Switch Threshold**: Lowered from 85% to 50%
- Any song match ‚â•50% confidence auto-switches (after 2 sustained matches)
- <50% confidence shows suggestion toast only
- Applies to ALL songs in setlist universally
- Commit: `ca8029e` - Lower auto-switch threshold

‚úÖ **Audio Capture**: Using `AudioContext` + `ScriptProcessorNode`
- Format: Linear PCM 16-bit (pcm_s16le), 16kHz, mono
- Session-aware sending: Only sends audio when `sessionActive=true`
- Uses `useRef` for `sessionActiveRef` to prevent stale closures

‚úÖ **Live Transcription**: Working correctly
- Backend broadcasts `TRANSCRIPT_UPDATE` to all event clients
- GhostText component always renders, shows "Listening..." when no transcript
- Transcripts appearing in operator HUD

‚úÖ **Next Slide Preview**: Shows 4 lines correctly (see screenshot)

### Issue: Main Slide Shows 1 Line (FIXED ‚úÖ)
**Root Cause**: Auto-switch DISPLAY_UPDATE missing `slideLines` and `slideText`

**Fix Applied** (Commit `32b443c`):
- Modified `backend/src/websocket/handler.ts` auto-switch logic (line 556-591)
- Now fetches full slide data: `session.songs[songIndex].slides[slideIndex]`
- Sends complete `slideLines` (array) and `slideText` (multi-line) in DISPLAY_UPDATE
- Added debug logging: "üì§ Sending DISPLAY_UPDATE for auto-switch: X lines"

**Result**: All slide display scenarios now show 4 lines correctly:
- ‚úÖ Session start (was working)
- ‚úÖ Manual override (was working)
- ‚úÖ Auto-switch (NOW FIXED!)

---

### Issue: Next Slide Preview Cut Off (FIXED ‚úÖ)
**Root Cause**: 4-line display with large fonts consumed too much vertical space

**Layout Optimizations** (Commit `05240c1`):

**CurrentSlideDisplay.tsx**:
- Font size: `text-5xl` ‚Üí `text-3xl` (48px ‚Üí 30px on large screens)
- Padding: `p-8` ‚Üí `py-4 px-4` (32px ‚Üí 16px vertical)
- Line spacing: `space-y-3` ‚Üí `space-y-1.5` (12px ‚Üí 6px)
- Margins: `mb-6/mt-6` ‚Üí `mb-3/mt-2` (24px ‚Üí 12px/8px)
- Leading: `leading-relaxed` ‚Üí `leading-snug`

**NextSlidePreview.tsx**:
- Font size: `text-lg` ‚Üí `text-sm` (18px ‚Üí 14px)
- Padding: `p-4` ‚Üí `p-3` (16px ‚Üí 12px)
- Line spacing: `space-y-1` ‚Üí `space-y-0.5` (4px ‚Üí 2px)
- Top margin: `mt-6` ‚Üí `mt-4` (24px ‚Üí 16px)

**OperatorHUD.tsx**:
- Container padding: `p-6` ‚Üí `p-4` (24px ‚Üí 16px)
- Overflow: `overflow-hidden` ‚Üí `overflow-y-auto` (scrollable if needed)

**Space Saved**: ~200px vertical space
**Result**: Both current slide (4 lines) + next slide preview now fit on screen

**Safety**: Revert to commit `6683919` if layout breaks

