# Daily Log — February 16, 2026

## Session: Hum-to-Search — YouTube-style embedding service + live hum + lazy Supabase init

### What we did

**1. Python embedding microservice (`hum-embedding-service/`)**
- FastAPI service using Wav2Vec2 (`facebook/wav2vec2-base`) for 768D audio embeddings.
- Endpoints: `GET /health`, `POST /embed` (WAV file → 768D vector).
- Audio trimmed to **30 seconds max** to avoid OOM on full-length tracks.
- Deployed to **Railway** (separate service in same project, root dir `hum-embedding-service/`).
- Start command: `uvicorn main:app --host 0.0.0.0 --port $PORT`.
- Files: `main.py`, `requirements.txt`, `README.md`, `.gitignore`.

**2. Supabase migration 017 — embedding column + match function**
- Added `embedding vector(768)` column to `song_fingerprints`.
- Created IVFFlat index on `embedding` (cosine ops).
- Created RPC `match_songs_by_embedding(query_embedding, match_threshold, match_count)` — cosine similarity search on 768D vectors, returns song info + lyrics.
- File: `supabase/migrations/017_embedding_column_and_match_songs_by_embedding.sql`.

**3. Backend: dual-path hum search**
- `humSearchService.ts`: When `EMBEDDING_SERVICE_URL` is set, uses YouTube-style path (POST WAV → embedding service → `match_songs_by_embedding`). Otherwise falls back to BasicPitch 128D + `match_songs`.
- `EMBEDDING_SERVICE_URL` read at **call time** (not module load) so dotenv works in scripts.
- `getEmbeddingFromService()` exported for use by ingest script.

**4. Live hum-to-search (match while humming)**
- New service: `humSearchLiveService.ts` — in-memory sessions with 5s rolling audio buffer.
- Processes 2s audio chunks, calls embedding service, searches via `match_songs_by_embedding`.
- Returns `{ status: 'listening' }` or `{ status: 'match', results }` when similarity crosses threshold.
- New API endpoints: `GET /api/hum-search/live/available`, `POST /api/hum-search/live/start`, `POST /api/hum-search/live/chunk`, `POST /api/hum-search/live/stop`.
- Frontend `ListeningOverlay.tsx`: "Match as you hum" checkbox (when available), streams chunks every 2s, shows results immediately on match.

**5. Ingest script updates**
- `scripts/ingest-audio.ts`: When `EMBEDDING_SERVICE_URL` is set, calls embedding service for each WAV to populate `embedding` column alongside `melody_vector`.
- Added **retry logic** (3 attempts with 5s/10s/15s backoff) for transient embedding service failures.
- Successfully ingested 2 songs (Way Maker + Amazing Grace) with both 128D and 768D vectors.

**6. Lazy Supabase client initialization (critical fix)**
- **Problem**: `backend/src/config/supabase.ts` read `process.env` at module load time. In scripts using `dotenv.config()`, imports ran first → Supabase client was null → false "not configured" warning.
- **Fix**: Refactored to lazy init via `ensureInit()` — reads env on first access. Exported `getSupabaseClient()` and `isSupabaseConfigured()` functions.
- Updated **all 8 consumer files**: `humSearchService.ts`, `humSearchLiveService.ts`, `eventService.ts`, `bibleService.ts`, `templateService.ts`, `seedDatabase.ts`, `index.ts`, `handler.ts`.

**7. TypeScript type-check fixes**
- `index.ts`: Prefixed unused `req` param with `_` in live/start route.
- `humSearchLiveService.ts`: Cast `wav.fmt` to typed object for `sampleRate` access (wavefile types `fmt` as `object`).

### EPIPE bug (root cause + fix)
- **Symptom**: Second song (Amazing Grace) failed with `write EPIPE` when calling embedding service.
- **Root cause**: Full-length WAV files (17–36 min) consumed all memory on Railway. After processing 96MB Way Maker, the container crashed mid-upload for the second file.
- **Fix**: Trim audio to 30s max in Python service (`MAX_DURATION_SECONDS = 30`). 30s at 16kHz = 480K samples vs 48M samples. Added retry logic in ingest script.

### Environment setup
- `backend/.env` (local): `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `EMBEDDING_SERVICE_URL=https://parleap-production.up.railway.app`
- Railway backend: same vars in service environment.
- Railway embedding service: no special vars needed (model downloads on first startup).

### Commits
- `ce41b7c` — feat: YouTube-style hum search (embedding service, live hum, migration 017, ingest dual-path)
- `2471838` — fix: trim audio to 30s in embedding service, read env at call time, retry on ingest
- `f5c421e` — refactor: lazy-init Supabase client to fix false "not configured" warning in scripts
- `f6d7e2c` — fix: resolve type-check errors in index.ts and humSearchLiveService.ts

### Files added
- `hum-embedding-service/main.py` (FastAPI embedding service)
- `hum-embedding-service/requirements.txt`
- `hum-embedding-service/README.md`
- `hum-embedding-service/.gitignore`
- `backend/src/services/humSearchLiveService.ts` (live hum-to-search)
- `supabase/migrations/017_embedding_column_and_match_songs_by_embedding.sql`

### Files modified
- `backend/src/config/supabase.ts` (lazy init)
- `backend/src/services/humSearchService.ts` (dual-path, call-time env)
- `backend/src/index.ts` (live hum endpoints, lazy supabase)
- `backend/scripts/ingest-audio.ts` (embedding + retry)
- `backend/src/services/eventService.ts` (lazy supabase)
- `backend/src/services/bibleService.ts` (lazy supabase)
- `backend/src/services/templateService.ts` (lazy supabase)
- `backend/src/utils/seedDatabase.ts` (lazy supabase)
- `backend/src/websocket/handler.ts` (lazy supabase)
- `frontend/components/search/ListeningOverlay.tsx` (live mode UI)
- `HUM_SEARCH_STATUS.md` (updated docs)

### Testing status
- Ingest: 2/2 songs processed successfully (retry caught transient EPIPE)
- End-to-end hum search: **pending user test**
- Live hum mode: **pending user test**

---
